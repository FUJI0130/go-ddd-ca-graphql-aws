# プロジェクト状況：AWS移行計画 (2025-4-3更新)

## 1. 方針変更の背景と概要

2025年3月27日の検討により、以下の方針変更を行いました：

1. **AWS環境への早期移行を最優先事項に設定**
   - アプリケーションの基本機能は実装済みであり、クラウド環境への移行を優先
   - ポートフォリオとしての価値を最大化するための方針

2. **最小限のフロントエンド実装を追加**
   - バックエンドAPIと連携するReactベースのフロントエンド
   - ユーザー認証、テストスイート管理の基本機能を実装

3. **認証機能の実装を追加**
   - JWTベースの認証システム
   - ユーザーロールによる権限管理

## 2. 進捗状況

### 2.1 完了した作業
- AWS移行計画の策定
- 優先順位マトリクスの作成
- エラーハンドリング方針の改善と実装
- **Dockerfileの作成と設計** (2025-3-29追加)
  - マルチステージビルドによる効率的なコンテナ構築
  - 1つのDockerfileで3種類のサービス（REST API, GraphQL, gRPC）に対応
  - ビルド引数による切り替え機能の実装
- **テスト用シェルスクリプトの作成** (2025-3-29追加)
  - サービスごとのテストスクリプト（REST API, GraphQL, gRPC）
  - ビルド、実行、検証を自動化
- **テストスクリプトの改善と環境依存性の低減** (2025-3-30追加)
  - jqコマンド依存の問題解決（フォールバック処理の実装）
  - 環境検出とネットワーク設定の自動調整
  - エラーハンドリングとデバッグ情報の強化
- **gRPCテストスクリプトの堅牢性向上** (2025-3-30追加)
  - grpcurlの有無に関わらず動作する堅牢な実装
  - 部分的テスト成功と完全テスト成功の明確な区別
  - エラー処理と結果報告の透明性向上
- **Terraformリモートステート環境構築** (2025-3-31追加)
  - デプロイスクリプト（deploy.sh）の改善と堅牢性向上
  - 動的リソース名生成機能の実装（AWS アカウントID活用）
  - S3バケットとDynamoDBテーブルのプロビジョニング
  - Terraform初期化の正常完了
- **Terraformモジュール再設計の完了** (2025-4-1追加)
  - 共有リソースと個別サービスの分離による競合問題解決
  - SSMパラメータストアを活用したシークレット管理の実装
  - モジュール間の依存関係の明確化
- **設定管理アーキテクチャの再設計と実装** (2025-4-2追加)
  - 12-Factor原則に準拠した設定管理システムの設計
  - 設定プロバイダーパターンの採用（環境変数、設定ファイル、デフォルト値の優先順位付け）
  - 透明な設定ソース（環境変数/設定ファイル）とロギング
  - データベース接続設定の改善
- **Dockerコンテナ設定の最適化** (2025-4-3追加)
  - Dockerfileにおける設定ファイル処理の改善
  - 設定ファイルよりも環境変数を優先する設計の明確化
  - サービスタイプに応じたヘルスチェック設定の最適化
  - AWS環境を考慮したコンテナ設計

### 2.2 進行中の作業
- **ECSサービスのデプロイ**
  - ✅ SSMパラメータの確認と設定
  - ✅ パラメータストアの重複エラー解決
  - 🔄 APIサービスのデプロイと検証
  - 🔄 ALBヘルスチェック設定の最適化
  - ⬜ GraphQLサービスのデプロイと検証（後続フェーズ）
  - ⬜ gRPCサービスのデプロイと検証（後続フェーズ）

- **認証機能の実装準備**
  - ⬜ ユーザーエンティティの設計
  - ⬜ JWT認証サービスの実装
  - ⬜ 認証ミドルウェアの設計

### 2.3 今後の作業予定
- **AWS環境のプロビジョニング**
  - ✅ AWSアカウント設定と認証情報構成
  - ✅ Terraformリモートステート環境構築
  - ✅ VPCとネットワークインフラの構築
  - ✅ RDSデータベースインスタンスの構築
  - 🔄 ECSサービスとロードバランサーの設定

- **認証機能の実装**
  - ⬜ JWT認証サービスの実装
  - ⬜ ユーザーエンティティとリポジトリの作成
  - ⬜ REST/GraphQL/gRPC用認証ミドルウェアの実装
  - ⬜ ユーザーDBスキーマの設計とマイグレーション

- **フロントエンド実装**
  - ⬜ React+TypeScriptプロジェクト設定
  - ⬜ ログイン画面実装
  - ⬜ テストスイート一覧・詳細画面実装

- **CI/CDパイプライン設定**
  - ⬜ GitLab CI/CD設定ファイル拡充
  - ⬜ ECRリポジトリ設定
  - ⬜ デプロイ自動化

## 3. 現状の実装状況

バックエンド部分は以下の機能が実装済み:
- REST API（基本的なCRUD操作）
- gRPCサービス（基本操作とストリーミング）
- GraphQL（基本クエリとDataLoader）
- エラーハンドリング（ドメインエラーの分類と変換）
- 設定管理（12-Factor原則に準拠）

AWS環境構築状況:
- VPCとネットワークインフラの構築完了
- RDSデータベースのデプロイ完了
- ECRリポジトリとイメージの準備完了
- SSMパラメータによるシークレット管理の設定
- ECSクラスターの作成完了

Docker環境でのテスト実行も完了:
- REST API、GraphQL、gRPCの各サービス用テストスクリプト
- 環境依存性を低減した堅牢な実装（jqコマンドのフォールバック処理）
- 自動的なデータベース起動と環境検出
- grpcurlの有無に対応した柔軟なテスト実行
- サービスタイプに応じたヘルスチェック設定の最適化

## 4. 作業計画とロードマップ

### 4.1 Week 1-2: 基盤整備と認証 (2025-03-29 〜 2025-04-11)
- ✅ Terraformプロジェクト構造の設計
- ✅ ネットワーク、データベース、ECS、ロードバランサーのモジュール実装
- ✅ Dockerfileプロジェクト構造の設計 (2025-3-29追加)
- ✅ テスト用シェルスクリプト作成 (2025-3-29追加)
- ✅ テストスクリプトの環境依存性低減とエラーハンドリング強化 (2025-3-30追加)
- ✅ 基本的なCI/CD設定ファイルの作成 (2025-3-30追加)
- ✅ AWS IAMユーザー設定とアクセスキー構成 (2025-3-31追加)
- ✅ Terraformリモートステート環境構築（S3 + DynamoDB） (2025-3-31追加)
- ✅ AWS VPC、RDS、ECS基本設定（Terraformコードの実行）
- ✅ 設定管理アーキテクチャの再設計と実装 (2025-4-2追加)
- ✅ Dockerコンテナ設定の最適化（サービスタイプ別ヘルスチェック） (2025-4-3追加)
- 🔄 ECSサービスのデプロイと検証
- ⬜ 認証機能実装
- ⬜ ブランチ戦略見直し

### 4.2 Week 3-4: インフラ構築とフロントエンド基盤 (2025-04-12 〜 2025-04-25)
- ⬜ CI/CD Pipeline設定
- ⬜ ログイン画面実装
- ⬜ テストスイート一覧画面実装
- ⬜ アプリケーションのコンテナ化とECRへのプッシュ

### 4.3 Week 5-6: フロントエンド機能拡充 (2025-04-26 〜 2025-05-09)
- ⬜ テストスイート詳細画面実装
- ⬜ テストケース管理UI基本実装
- ⬜ CloudWatch設定
- ⬜ デプロイ自動化完成

### 4.4 Week 7-8: 機能強化と最終調整 (2025-05-10 〜 2025-05-23)
- ⬜ レスポンシブデザイン対応
- ⬜ ドキュメント整備
- ⬜ テスト自動化
- ⬜ 最終調整とデバッグ

## 5. 技術スタックと詳細

### 5.1 AWS環境設計

```
┌──────────────────────────────────────────────────────────┐
│                         AWS Cloud                         │
│                                                          │
│  ┌─────────┐     ┌─────────────┐     ┌────────────────┐  │
│  │  Route53 │────┤ API Gateway │────┤ Load Balancer  │  │
│  └─────────┘     └─────────────┘     └────────────────┘  │
│       │                                       │          │
│       │                                       │          │
│  ┌─────────┐                        ┌─────────────────┐  │
│  │ CloudFront│                       │ ECS Cluster    │  │
│  └─────────┘                        │                │  │
│                                     │  ┌──────────┐  │  │
│                                     │  │Container │  │  │
│  ┌─────────────┐                    │  │(REST API)│  │  │
│  │ CloudWatch  │                    │  └──────────┘  │  │
│  └─────────────┘                    │  ┌──────────┐  │  │
│       ▲                             │  │Container │  │  │
│       │                             │  │(GraphQL) │  │  │
│       │                             │  └──────────┘  │  │
│       │                             │  ┌──────────┐  │  │
│  ┌─────────────┐                    │  │Container │  │  │
│  │ AWS Lambda  │                    │  │(gRPC)    │  │  │
│  └─────────────┘                    │  └──────────┘  │  │
│                                     └─────────────────┘  │
│                                                │         │
│                                                ▼         │
│  ┌─────────────┐     ┌─────────────┐     ┌────────────┐  │
│  │ S3 Bucket   │     │  RDS        │     │ElastiCache │  │
│  │(Logs/Assets)│     │(PostgreSQL) │     │(Redis)     │  │
│  └─────────────┘     └─────────────┘     └────────────┘  │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 5.2 Terraformプロジェクト構造

```
deployments/terraform/
├── environments/
│   ├── development/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── terraform.tfvars
│   └── production/
│       ├── main.tf
│       ├── variables.tf
│       └── terraform.tfvars
└── modules/
    ├── networking/
    │   ├── main.tf
    │   ├── variables.tf
    │   └── outputs.tf
    ├── database/
    │   ├── main.tf
    │   ├── variables.tf
    │   └── outputs.tf
    ├── ecs/
    │   ├── main.tf
    │   ├── variables.tf
    │   └── outputs.tf
    ├── service/
    │   ├── ecs-service/
    │   │   ├── main.tf
    │   │   ├── variables.tf
    │   │   └── outputs.tf
    │   └── load-balancer/
    │       ├── main.tf
    │       ├── variables.tf
    │       └── outputs.tf
    └── shared/
        ├── ecs-cluster/
        │   ├── main.tf
        │   ├── variables.tf
        │   └── outputs.tf
        └── secrets/
            ├── main.tf
            ├── variables.tf
            └── outputs.tf
```

### 5.3 AWS構成コンポーネント

- **ネットワーク**: VPC、パブリック/プライベートサブネット (複数AZ)
- **コンピューティング**: ECS Fargate
- **データベース**: RDS PostgreSQL
- **ロードバランサー**: ALB
- **CDN**: CloudFront
- **DNS**: Route53
- **監視**: CloudWatch
- **シークレット管理**: Systems Manager Parameter Store

### 5.4 認証設計（計画中）

- **方式**: JWTベースのトークン認証
- **ユーザーロール**:
  - Admin: すべての操作が可能
  - Manager: テストスイート作成・更新、ケース管理
  - Tester: テストケース更新、工数記録
- **実装予定コンポーネント**:
  - JWTサービス（internal/infrastructure/auth/jwt_service.go）
  - ユーザーエンティティとリポジトリ
  - 認証ミドルウェア（REST/GraphQL/gRPC各対応）

### 5.5 フロントエンド仕様（計画中）

- **フレームワーク**: React 18+
- **言語**: TypeScript 5+
- **状態管理**: React Context API + React Query
- **UIライブラリ**: Material UI または Chakra UI
- **API通信**: GraphQL (Apollo Client)
- **ビルドツール**: Vite

## 6. 課題と対応状況

### 6.1 解決済みの課題
- Terraformモジュール間の依存関係管理
- 環境分離（開発/本番）の設計
- エラーハンドリングの改善
- Docker環境でのテスト実行の環境依存問題 (2025-3-30追加)
  - jqコマンドへの依存問題を解決（フォールバック処理の実装）
  - データベース接続設定の自動検出
- grpcurlコマンドへの依存性対応 (2025-3-30追加)
  - コマンドの有無を検出し、適切なテスト方法を選択する実装
  - テスト結果の透明性向上と部分的/完全テスト成功の区別
- Terraformリモートステート環境の競合問題 (2025-3-31追加)
  - バケット名の競合によるデプロイエラー解決
  - 動的リソース名生成による一意性の確保
  - スクリプトのエラーハンドリング強化
- Terraformモジュールの設計問題 (2025-4-1追加)
  - リソース名の競合によるデプロイエラーを解消
  - 共有リソースと個別サービスのモジュール分離実装
- SSMパラメータの重複定義問題 (2025-4-1追加)
  - `main.tf`内での重複リソース定義を解消
  - `overwrite = true`パラメータの適切な設定
- 設定管理アーキテクチャの問題 (2025-4-2追加)
  - 環境変数が設定ファイルよりも優先されない問題を解決
  - 12-Factor原則に準拠した設定管理システムの設計と実装
  - 設定ソースの透明化と機密情報の適切な処理
- Dockerコンテナ設定の最適化 (2025-4-3追加)
  - 設定ファイル管理の方針を明確化
  - サービスタイプに応じたヘルスチェック設定の実装
  - コンテナとALBのヘルスチェック連携の最適化

### 6.2 未解決の課題
- ECSサービスデプロイの完了
- ALBヘルスチェック設定の最適化
- フロントエンド認証の実装方針

### 6.3 リスク管理
- コスト管理：開発環境では最小構成を採用
- セキュリティ：最小権限の原則を適用
- 可用性：本番環境ではマルチAZ構成を検討

## 7. 関連ドキュメント

以下の詳細設計ドキュメントを参照してください：

1. **AWS実装計画書**: AWS環境の全体設計と実装範囲
2. **AWS Terraform設計書**: インフラストラクチャのコード化計画
3. **AWS CI/CDパイプライン設計書**: GitLab CI/CDとAWSの連携方法
4. **認証機能実装計画書**: JWTベースの認証システム設計
5. **フロントエンドMVP仕様書**: 最小限必要な画面と機能の定義
6. **プロジェクト優先順位マトリクス**: 機能と作業項目の優先順位評価
7. **AWS環境構築ガイド**: AWS環境構築の手順と知見
8. **AWS ECSシークレット管理ガイド**: ECSでのシークレット管理方式と実装
9. **設定管理アーキテクチャの詳細分析**: 12-Factor原則に基づく設定管理の設計 (2025-4-2追加)
10. **AWS ECSにおけるヘルスチェック戦略**: コンテナとALBのヘルスチェック設定 (2025-4-3追加)

## 8. 次のアクション (2025-4-3更新)

### 8.1 ALBヘルスチェック設定の確認と最適化
- **Terraformコードの確認**
  ```bash
  # ターゲットグループのヘルスチェック設定を確認
  terraform -chdir=deployments/terraform/environments/development state show 'module.loadbalancer_api.aws_lb_target_group.main'
  ```
  
- **ヘルスチェック設定の最適化案**
  ```hcl
  health_check {
    path                = "/health"
    protocol            = "HTTP"
    port                = "traffic-port"
    interval            = 30
    timeout             = 5
    healthy_threshold   = 3
    unhealthy_threshold = 3
  }
  ```

### 8.2 REST APIサービスの再デプロイと検証
- **サービスの再デプロイ**
  ```bash
  make redeploy-api TF_ENV=development
  ```
  
- **デプロイ結果の検証**
  ```bash
  make verify-service SERVICE_TYPE=api TF_ENV=development
  ```

### 8.3 次のフェーズの準備
- **GraphQLサービスのデプロイ事前準備**
  ```bash
  make prepare-ecr-image SERVICE_TYPE=graphql TF_ENV=development
  ```
  
- **gRPCサービスのデプロイ事前準備**
  ```bash
  make prepare-ecr-image SERVICE_TYPE=grpc TF_ENV=development
  ```