# AWS環境のリソース管理とコスト最適化ガイド

## 1. 背景と目的

AWSリソースの効率的な管理とコスト最適化は、プロジェクトの持続可能性にとって重要です。このガイドでは、AWS環境とTerraform状態の一貫性を確保しながら、コスト効率の良いリソース管理を実現するためのベストプラクティスを説明します。

### 1.1 AWS環境とTerraform状態の一貫性問題

従来、当プロジェクトでは以下の課題が確認されていました：

- AWS CLIで直接リソースを削除するとTerraform状態が更新されない問題
- 複数の類似コマンドによる混乱
- 開発ライフサイクルに沿った直感的なリソース管理フローの欠如

### 1.2 解決アプローチ

これらの課題を解決するため、以下のアプローチを採用しました：

1. Terraformモジュール構造の改善（循環依存問題の解決）
2. AWS CLIベースのクリーンアップからTerraformベースのクリーンアップへの移行
3. 開発ライフサイクルに基づいた新コマンド体系の導入

## 2. 開発ライフサイクル管理

開発ライフサイクルに基づいた新しいコマンド体系により、AWS環境を効率的に管理できます。

### 2.1 開発開始

```bash
# 開発環境のコア基盤をデプロイ
make start-dev TF_ENV=development
```

**実行内容**:
- VPCとネットワークリソースのデプロイ
- RDSデータベースインスタンスのデプロイ 
- ECSクラスターと共有リソースのデプロイ
- SSMパラメータストアの設定

**コスト影響**: 約$0.80/日（RDSが主要コスト）

### 2.2 開発一時停止

```bash
# ECSサービスとALBを削除し、コア基盤は維持
make pause-dev TF_ENV=development
```

**実行内容**:
- ECSサービスとタスクの削除
- ロードバランサーとターゲットグループの削除
- Terraform状態の更新

**コスト削減**: 約$1.00/日  
**再開時間**: 約5分  
**使用シナリオ**: 数時間〜数日の開発休止

### 2.3 開発再開

```bash
# 一時停止状態から開発を再開
make resume-dev TF_ENV=development
```

**実行内容**:
- ターゲットグループの再デプロイ
- ロードバランサーの再デプロイ
- ECSサービスの再デプロイ

**追加コスト**: 約$1.00/日  
**所要時間**: 約5分

### 2.4 開発停止

```bash
# すべてのAWSリソースを削除
make stop-dev TF_ENV=development
```

**実行内容**:
- すべてのAWSリソースの削除
- Terraform状態の更新

**コスト削減**: 約$2.00/日（すべてのリソース）  
**再開時間**: 約30分（フルデプロイが必要）  
**使用シナリオ**: 数日以上の長期開発休止

### 2.5 クイックテスト

```bash
# 一時的なテスト環境をデプロイし、検証後に自動的に削除
make quick-test TF_ENV=development
```

**実行内容**:
- コア基盤のデプロイ
- APIサービスのデプロイと検証
- 検証完了後の自動クリーンアップ

**コスト影響**: 約$0.10（約1時間の使用を想定）  
**使用シナリオ**: 短時間の検証作業

## 3. リソース管理とコスト最適化

### 3.1 AWSリソースとコスト構造

以下の表は主要なAWSリソースとそのコスト影響を示しています：

| リソース | 概算コスト (USD/日) | 主な削減方法 | コマンド |
|--------|-------------------|------------|--------|
| RDSインスタンス | 0.80 | 停止または削除 | `make terraform-cleanup-standard` |
| ECSサービス | 0.50 | 停止 | `make pause-dev` |
| ロードバランサー | 0.54 | 削除 | `make pause-dev` |
| NAT Gateway | 0.20 | 削除 | `make stop-dev` |
| VPC/サブネット | 最小 | 不要な場合のみ削除 | `make stop-dev` |

### 3.2 コスト監視と確認

```bash
# 現在のリソース状態とコスト見積もりを取得
make cost-estimate TF_ENV=development

# 詳細なリソース状態を確認
make check-resources TF_ENV=development
```

### 3.3 コスト最適化戦略

1. **作業スケジュールに応じたリソース管理**
   - 日次作業時: 必要なサービスのみデプロイ
   - 夜間/週末: `make pause-dev` で一時停止
   - 長期休暇: `make stop-dev` で完全停止

2. **リソースサイズの最適化**
   - 開発環境では最小インスタンスサイズを使用
   - RDS: db.t3.micro
   - ECS Fargate: 最小タスク数

3. **不要なリソースの削除**
   - 使用していないECRイメージの定期的なクリーンアップ
   - 未使用のEBSボリュームの確認と削除

## 4. Terraform状態の一貫性確保

### 4.1 状態の一貫性確認

```bash
# Terraformの状態とAWS環境の検証
make terraform-verify TF_ENV=development
```

### 4.2 問題検出時の状態修復

```bash
# 状態のバックアップ
make terraform-backup TF_ENV=development

# 状態のリセット
make terraform-reset TF_ENV=development

# リソースのインポート（必要に応じて）
cd deployments/terraform/environments/development
terraform import module.networking.aws_vpc.main <vpc-id>
```

### 4.3 Terraformモジュール構造の最適化

最近実施したモジュール構造の改善により、以下の問題が解決されました：

1. **ターゲットグループの分離**
   - ECSサービスとALB間の循環依存問題を解決
   - サービスタイプに応じたヘルスチェック設定の標準化

2. **共有リソースと個別サービスの分離**
   - リソース名の競合によるデプロイエラーの解消
   - モジュール間の依存関係の明確化

## 5. リソース管理のベストプラクティス

### 5.1 開発作業のプランニング

1. **リソースライフサイクルの予測**
   - 作業開始前に必要なリソースと期間を計画
   - 適切なコマンドを選択（start-dev/pause-dev/stop-dev）

2. **検証作業の効率化**
   - 短時間の検証には `make quick-test` を活用
   - 検証が完了したら速やかにリソースを削除

### 5.2 AWSコンソールとの連携

Terraformで管理しているリソースをAWSコンソールで確認する際の注意点：

1. **直接編集を避ける**
   - コンソールでの設定変更はTerraform状態に反映されない
   - 変更が必要な場合はTerraformコードを修正する

2. **必須の手動操作**
   - ECRリポジトリのイメージライフサイクルポリシー設定
   - CloudWatchアラームの確認

### 5.3 コスト異常の検出と対応

1. **定期的なコスト確認**
   - 少なくとも週1回は `make cost-estimate` を実行
   - 予想外のコスト増加がないか確認

2. **異常検出時の対応**
   - `make check-resources` で異常なリソースを特定
   - 不要なリソースは適切なコマンドで削除

## 6. トラブルシューティング

### 6.1 よくある問題と解決策

1. **ECSサービスのデプロイ失敗**
   - 症状: タスク定義は更新されるがサービスが起動しない
   - 解決: ALBヘルスチェック設定を確認し、ヘルスチェックパスが正しいか検証

2. **Terraform状態の不一致**
   - 症状: `terraform plan` で予期しない変更が表示される
   - 解決: `make terraform-verify` を実行し、必要に応じてリソースをインポート

3. **リソースの削除失敗**
   - 症状: 依存関係によりリソースが削除できない
   - 解決: 依存するリソースを先に削除するか、強制削除オプションを検討

### 6.2 ヘルスチェック関連の問題

ALBヘルスチェック設定の最適化により、以下の問題が解決されました：

1. **REST APIサービスのヘルスチェック**
   - ヘルスチェックエンドポイントをルートレベル(`/health`)に移動
   - 404エラーによるヘルスチェック失敗問題を修正

2. **GraphQL/gRPCサービスのヘルスチェック**
   - 長めのタイムアウトと間隔設定の必要性を確認
   - 適切なヘルスチェックパスの設定

## 7. 今後の改善計画

### 7.1 自動化の強化

1. **スケジュールベースのリソース管理**
   - 夜間・週末の自動停止/起動
   - コスト閾値に基づく自動アラート

2. **コスト最適化レポートの自動生成**
   - 週次/月次のコスト傾向
   - リソース使用効率の分析

### 7.2 推奨されるリソース管理フロー

開発チームに推奨される日常的なリソース管理フロー：

```
1. 作業開始時:
   make start-dev TF_ENV=development
   make deploy-api TF_ENV=development  # 必要なサービスのみ

2. 日次作業終了時:
   make pause-dev TF_ENV=development  # 夜間コスト削減

3. 作業再開時:
   make resume-dev TF_ENV=development

4. 長期休暇前:
   make stop-dev TF_ENV=development  # 完全クリーンアップ
```

## 8. 参考リソース

- [Makefile解説ドキュメント](../Makefile解説ドキュメント.md)
- [Terraform状態管理ガイド](../terraform-state-management-guide.md)
- [AWS公式ドキュメント: コスト最適化のベストプラクティス](https://aws.amazon.com/architecture/cost-optimization/)