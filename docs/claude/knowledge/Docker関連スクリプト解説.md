# Docker関連スクリプト解説

## 概要

`scripts/docker`ディレクトリには、テストケース管理システムのDockerコンテナの構築、テスト、およびECRへのプッシュを自動化するためのスクリプトが含まれています。これらのスクリプトにより、各種サービス（REST API、GraphQL、gRPC）のコンテナをローカル環境で起動し、基本機能テストを実行できます。

## 1. prepare-ecr-image.sh - ECRイメージ準備スクリプト

`scripts/docker/prepare-ecr-image.sh`は、特定のサービスタイプ（API、GraphQL、gRPC）のDockerイメージをビルドし、AWS Elastic Container Registry (ECR)にプッシュするためのスクリプトです。

### 主要機能

1. **サービスタイプと環境の指定**
   - コマンドライン引数からサービスタイプと環境を受け取る
   - 有効なサービスタイプと環境の検証

2. **ECRリポジトリの自動管理**
   - リポジトリの存在確認
   - 必要に応じて新しいリポジトリの作成

3. **Dockerイメージのビルドとプッシュ**
   - サービスタイプに応じたビルド引数の設定
   - ECRへのログイン
   - イメージのタグ付けとプッシュ

4. **terraform.tfvars連携のヒント**
   - 生成されたイメージURIをterraform.tfvarsで使用するためのガイダンス
   - update-tfvars.shスクリプトへの連携

### 使用例

```bash
# 開発環境のAPIサービス用イメージを準備
./scripts/docker/prepare-ecr-image.sh api development

# 本番環境のGraphQLサービス用イメージを準備
./scripts/docker/prepare-ecr-image.sh graphql production
```

### 注意点

- AWS CLIがインストールされていること
- 適切なAWS認証情報が設定されていること
- Dockerfileがプロジェクトルートに存在すること

## 2. test-api.sh - REST APIテストスクリプト

`scripts/docker/test-api.sh`は、REST APIサービスのDockerコンテナをローカル環境で起動し、基本的な機能テストを実行するスクリプトです。

### 主要機能

1. **環境の準備**
   - 既存のAPIコンテナのクリーンアップ
   - データベースコンテナの起動確認（必要に応じて起動）
   - Dockerネットワークの自動検出

2. **コンテナの起動**
   - APIサービス用のDockerイメージのビルド
   - 検出されたネットワークに基づくコンテナ起動設定
   - bridge/カスタムネットワークの両方に対応

3. **動作確認**
   - ヘルスチェックエンドポイントの呼び出し
   - テストスイート一覧APIの呼び出し

4. **対話的なクリーンアップ**
   - テスト後の動作を選択可能（実行継続/コンテナのみ停止/全停止）

### 使用例

```bash
# APIサービスのテスト実行
./scripts/docker/test-api.sh
```

### 特徴

- エラー発生時の自動クリーンアップ
- コンテナログの表示
- データベース接続の自動設定（ホストIP/コンテナ名）

## 3. test-graphql.sh - GraphQLテストスクリプト

`scripts/docker/test-graphql.sh`は、GraphQLサービスのDockerコンテナをローカル環境で起動し、基本的な機能テストを実行するスクリプトです。

### 主要機能

1. **環境の準備**
   - 既存のGraphQLコンテナのクリーンアップ
   - データベースコンテナの起動確認
   - Dockerネットワークの自動検出

2. **テストデータの管理**
   - GraphQLクエリファイルの自動作成
   - クエリディレクトリの管理

3. **GraphQL固有の機能テスト**
   - GraphQL Playgroundへのアクセス確認
   - サンプルクエリの実行とレスポンス検証
   - jqコマンドの有無に対応したJSON処理

4. **対話的な操作**
   - テスト後のオプション（実行継続/停止/GraphQL Playground起動/新規クエリ追加）

### 使用例

```bash
# GraphQLサービスのテスト実行
./scripts/docker/test-graphql.sh
```

### 特徴

- クエリファイルの管理機能
- GraphQL Playgroundへのアクセス支援
- ブラウザ自動起動機能（OS検出）

## 4. test-grpc.sh - gRPCテストスクリプト

`scripts/docker/test-grpc.sh`は、gRPCサービスのDockerコンテナをローカル環境で起動し、基本的な機能テストを実行するスクリプトです。

### 主要機能

1. **環境の準備**
   - 既存のgRPCコンテナのクリーンアップ
   - データベースコンテナの起動確認
   - Dockerネットワークの自動検出

2. **gRPC固有の機能テスト**
   - grpcurlコマンドによるサービス一覧の取得
   - grpcurlがない場合の代替検証方法の提供
   - テスト成功の粒度付け（完全/部分的）

3. **対話的なクリーンアップ**
   - テスト後の動作を選択可能

### 使用例

```bash
# gRPCサービスのテスト実行
./scripts/docker/test-grpc.sh
```

### 特徴

- grpcurlコマンドの有無による動的検証方法の切り替え
- 部分的なテスト成功の概念の導入
- テスト結果の明確な表示

## 改善状況と相違点

APIスクリプト(`test-api.sh`)と他の2つのスクリプト（`test-graphql.sh`、`test-grpc.sh`）には、いくつかの構造的・機能的な違いがあります：

### APIスクリプトの改善点

1. **ネットワーク検出の明確化**
   - より堅牢なネットワーク検出ロジック
   - 明示的なNETWORK_NAME変数の宣言

2. **エラーハンドリングの強化**
   - APIエンドポイント呼び出し失敗時の明確なエラーメッセージ
   - コンテナログの表示が自動的に行われる

3. **シンプルな構造**
   - 基本的な機能に焦点を当てた構造
   - 余分な機能を省略（クエリ管理など）

### GraphQLスクリプトの特徴的な機能

1. **クエリ管理機能**
   - クエリファイルの自動作成と管理
   - jq依存の解決策（jqがない環境での代替処理）

2. **インタラクティブな機能**
   - GraphQL Playground起動オプション
   - 新規クエリ追加機能

3. **拡張テスト機能**
   - 複数のGraphQLクエリ実行による詳細な検証

### gRPCスクリプトの特徴的な機能

1. **ツール依存性への対応**
   - grpcurlの有無による検証方法の動的切り替え
   - 部分的なテスト成功の概念

2. **検証結果の段階付け**
   - 完全成功 vs 部分的成功の区別
   - より詳細なテスト結果の表示

## 推奨される改善

今後、これらのスクリプトを標準化・改善するための推奨事項：

1. **共通部分の抽出**
   - 環境準備、ネットワーク検出などの共通処理を関数化
   - 共有ライブラリとして切り出し

2. **環境依存性の低減**
   - jq、grpcurlなどの依存性への対応をすべてのスクリプトに適用
   - `json_utils.sh`のような共通ユーティリティの活用

3. **ドキュメント強化**
   - スクリプト内のコメント充実
   - 使用例とオプションの詳細説明

4. **エラーハンドリングの統一**
   - すべてのスクリプトで一貫したエラーハンドリングパターンの採用
   - 診断情報の標準化

5. **フィードバック機能の強化**
   - 視覚的なステータス表示（色付きの進捗表示など）
   - 詳細なデバッグ情報のオプション表示