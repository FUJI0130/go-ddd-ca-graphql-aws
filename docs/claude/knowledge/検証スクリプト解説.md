# 検証スクリプト解説

## 概要

`scripts/verification`ディレクトリに含まれる検証スクリプトは、AWSのECS環境にデプロイされたサービス（REST API、GraphQL、gRPC）の稼働状況を検証するために使用されます。これらのスクリプトは、サービスのデプロイが成功し、正常に動作しているかを確認するための総合的な検証を提供します。

## 1. verify-ecs-api.sh - REST API検証スクリプト

`scripts/verification/verify-ecs-api.sh`スクリプトは、ECSにデプロイされたREST APIサービスの稼働状況を検証します。

### 主要機能

1. **共通ユーティリティの活用**
   - `json_utils.sh`を使用してJSON処理の環境依存性を低減
   - jqの有無に関わらず一貫した処理を実現

2. **ECSサービスの検証**
   - サービスの存在確認
   - サービスのステータス確認（ACTIVE状態か）
   - デプロイメントのステータス確認
   - 実行中と期待されるタスク数の比較

3. **ALBヘルスチェック検証**
   - ターゲットグループの健全性確認
   - 不健全なターゲットの詳細表示
   - 一定時間待機してヘルスチェックの完了を待機

4. **APIエンドポイントテスト**
   - ヘルスチェックエンドポイント（/health）へのHTTPリクエスト
   - レスポンスコードの検証

### 堅牢性機能

- **リトライメカニズム**: ヘルスチェックが完了するまで一定回数リトライ
- **環境依存性の低減**: jqコマンドの有無に関わらず動作
- **診断情報の充実**: 問題発生時に詳細な診断情報を表示
- **柔軟なエラーハンドリング**: 様々なエラーケースに対応

### 使用例

```bash
# 開発環境のAPIサービス検証
./scripts/verification/verify-ecs-api.sh development

# 本番環境のAPIサービス検証
./scripts/verification/verify-ecs-api.sh production
```

## 2. verify-ecs-graphql.sh - GraphQL検証スクリプト

`scripts/verification/verify-ecs-graphql.sh`スクリプトは、ECSにデプロイされたGraphQLサービスの稼働状況を検証します。

### 主要機能

1. **ECSサービスの検証**
   - サービスのステータス確認
   - デプロイメントのステータス確認
   - 実行中タスク数の確認

2. **ALBヘルスチェック検証**
   - ターゲットグループの健全性確認
   - 不健全なターゲットの詳細表示

3. **GraphQLエンドポイントテスト**
   - 基本的なスキーマクエリ（introspection query）の実行
   - テストスイート一覧クエリの実行による機能検証

### 特徴

- GraphQLの特性に合わせた詳細な機能検証
- スキーマの取得とテストスイート一覧クエリによる多層的検証
- GraphQL固有のエラー応答解析

## 3. verify-ecs-grpc.sh - gRPC検証スクリプト

`scripts/verification/verify-ecs-grpc.sh`スクリプトは、ECSにデプロイされたgRPCサービスの稼働状況を検証します。

### 主要機能

1. **ECSサービスの検証**
   - サービスのステータス確認
   - デプロイメントのステータス確認
   - 実行中タスク数の確認

2. **ALBヘルスチェック検証**
   - ターゲットグループの健全性確認
   - 不健全なターゲットの詳細表示

3. **gRPCサービステスト**
   - grpcurlコマンドを使用したサービス一覧の取得
   - TestSuiteServiceの存在確認
   - ListTestSuitesメソッドの動作テスト

### 堅牢性機能

- **ツール依存性への対応**: grpcurlがない場合の代替検証手段の提供
- **段階的な検証**: サービス存在確認 → メソッド一覧取得 → 実際のメソッド呼び出し
- **複数のフォールバック手段**: nc、curl等を使った複数の検証手段

## 共通の構造とパターン

3つのスクリプトには、以下の共通パターンが見られます：

1. **段階的な検証フロー**
   - サービス存在と基本状態の確認
   - デプロイメント状態の確認
   - タスク実行状況の確認
   - ロードバランサーとターゲットグループの確認
   - エンドポイント動作確認

2. **視覚的フィードバック**
   - 色付きの出力で状態を明確に表示
   - 成功（緑）、警告（黄）、エラー（赤）の区別

3. **リトライメカニズム**
   - ヘルスチェック完了までの待機と再試行
   - 設定可能な最大リトライ回数とインターバル

## APIスクリプトの先進的機能と今後の拡張

APIスクリプトには、以下の先進的な機能が実装されており、他のスクリプトにも拡張可能です：

1. **環境依存性の低減**
   - `json_utils.sh`の活用によるjq依存の解消
   - AWS CLIの`--query`オプションを活用した代替実装

2. **共通コードの再利用**
   - 共通処理の外部化による保守性向上
   - スクリプト間での一貫性確保

3. **より詳細な診断情報**
   - 失敗したタスクの詳細な原因表示
   - デバッグログの追加

## 使用上の注意点

1. **AWS認証情報**
   - スクリプト実行には適切なAWS認証情報が必要

2. **環境名の指定**
   - 環境名（development/production）をパラメータとして指定
   - 未指定時はデフォルトで`development`を使用

3. **依存ツール**
   - APIスクリプト: AWS CLI、curl（json_utilsによりjqは任意）
   - GraphQLスクリプト: AWS CLI、jq、curl
   - gRPCスクリプト: AWS CLI、jq、grpcurl（任意）、nc（任意）

## 推奨事項

1. **エラー出力の標準化**
   - API検証スクリプトの環境依存性低減パターンを他のスクリプトにも適用
   - `json_utils.sh`の活用拡大

2. **検証の自動化**
   - CIパイプラインへの組み込み
   - デプロイ完了後の自動検証実行

3. **拡張機能の追加**
   - より詳細なAPICRUDテスト
   - パフォーマンステスト
   - セキュリティヘッダー検証