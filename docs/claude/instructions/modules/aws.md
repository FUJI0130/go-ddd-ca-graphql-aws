# AWS環境管理モジュール

## AWS実装ガイドライン

1. **環境構築**:
  - Terraformを使用したインフラストラクチャのコード化
  - 環境変数・シークレット管理の統一
  - 最小構成からスタートし、徐々に拡張
  - 各コンポーネントのデプロイ前にAWS環境構築解説ガイドの対応セクションを参照

2. **CI/CD**:
  - GitLab CI/CDとAWSの連携
  - 環境分離（development, staging, production）
  - セキュアなデプロイプロセスの構築
  - パイプライン設定時にはセキュリティ面の考慮を徹底

3. **セキュリティ**:
  - 最小権限の原則の適用
  - 機密情報の適切な管理
  - ネットワークセキュリティの確保
  - 多層防御戦略の実装

4. **トラブルシューティング**:
  - AWS環境構築解説ガイドの実践的なチェックコマンドを活用
  - 問題発生時の体系的な調査アプローチ
  - コンポーネント間の関係性を考慮した原因特定

## AWS環境構築知識の活用と学習プロセス

1. **プロジェクト完成を優先した段階的アプローチ**:
  - プロジェクトの完成を最優先目標として設定
  - AWS環境構築解説ガイドをリファレンスとして活用
  - 各デプロイステップで参照すべき解説ガイドのセクションを明示
  - 全ての要素を完璧に理解するよりも、プロジェクト全体の完成を優先

2. **核となる理解ポイント**:
  - アーキテクチャ全体像：システム構成とデータフロー
  - 主要コンポーネント：VPC、サブネット、セキュリティグループ、RDS、ECS
  - セキュリティ設計：多層防御戦略、権限管理
  - **コスト管理：リソースのライフサイクル、自動削除、最小構成の活用**
  - これらのポイントについては、ポートフォリオ説明時に自信を持って説明できるレベルの理解を目指す

3. **最小限の実践ポイント**:
  - VPC設計確認：AWS Management Consoleでの可視化と設定確認
  - セキュリティグループ設定：主要ルールの確認と理解
  - RDS接続テスト：実際のデータベース接続確認
  - **コスト管理：クリーンアップコマンドの活用と定期的なコスト確認**
  - これらのハンズオンはプロジェクト進行を妨げない範囲で実施

4. **プロジェクト完成後の学習計画**:
  - AWS環境構築解説ガイドの体系的な学習
  - 各コンポーネントごとの詳細なハンズオン実施
  - アーキテクチャの発展的検討と最適化
  - **コスト最適化戦略の詳細検討と実装**

## AWS作業時の追加注意事項

1. **AWSコスト管理とリソース利用**:
  - AWS関連の作業では、不要なリソースの自動削除を徹底し、コスト最小化を意識
  - 検証が完了したら `cleanup-minimal` などのコマンドでリソースをクリーンアップ
  - 長時間のテスト/検証は避け、検証後に速やかにリソースを削除
  - 開発/テスト目的では最小限のリソース構成を使用（小さなインスタンスサイズなど）
  - リソースの存在状況と課金状態を定期的に確認（`make cost-estimate`）

2. **AWS環境のクリーンアップ確認**:
  - 作業で使用したAWSリソースが適切に削除されたか確認
  - リソース状態とコスト影響の報告
  - **AWS環境のリソース状態を確認**
    - `make cost-estimate` を実行して現在のリソース状況を確認
    - 必要なリソースのみが存在することを確認
    - 新しいリソースをデプロイする前に、不要なリソースを削除

3. **AWS環境構築作業**:
  - AWS関連の設計・実装はナレッジファイル「aws-migration-plan.md」「aws-implementation-plan.md」
    「aws-terraform-design.md」「aws-cicd-pipeline.md」を参照
  - AWS関連の作業は、スクリプトファイル、Makefileのコマンドを使うことがあるため、
    「共通ユーティリティスクリプト解説」「Terraform関連スクリプト解説」「検証スクリプト解説」
    「Docker関連スクリプト解説」「Makefile解説ドキュメント」を参照
  - AWS環境構築作業、AWSに関する作業を行った場合は、「AWS環境構築ガイド」ドキュメントを更新し、
    実施した作業内容と手順、注意点などを追記する。このドキュメントは将来的なAWS環境構築の
    参考資料として活用できるよう詳細に記録すること

4. **AWS環境状態の報告**:
  - AWS環境状態レポートを作成
    ```
    ## AWS環境状態
    
    ### 使用したリソース
    - RDSインスタンス: 削除済み（cost-impact: 約$0.80/日）
    - ECSサービス: 削除済み（cost-impact: 約$0.50/日）
    - ロードバランサー: 削除済み（cost-impact: 約$0.54/日）
    
    ### 削除確認
    cleanup-standard コマンドでRDSまでのリソースを削除しました。
    確認コマンド: `make cost-estimate` で確認済み
    
    ### 次回作業時の注意
    - 残存しているECSクラスターとネットワークリソースは低コスト（約$0.05/日）のため保持
    - 1週間以上作業がない場合は `make cleanup-complete` で完全削除推奨
    ```

## 主要AWSコマンドリファレンス

作業効率化のため、以下の主要コマンドを把握しておくことを推奨します。詳細は「Makefileコマンド解説.md」を参照してください。

### 環境確認コマンド
```bash
# AWS環境の状態確認
make tf-status                     # Terraformの状態を表示
make cost-estimate                 # 現在のリソースとコスト見積もりを表示
```

### デプロイコマンド
```bash
# コンポーネント単位のデプロイ
make deploy-network                # ネットワークインフラをデプロイ
make deploy-database               # データベースをデプロイ
make deploy-ecs-cluster            # ECSクラスターをデプロイ

# サービスデプロイ
make deploy-api TF_ENV=development # APIサービスをデプロイ
make deploy-graphql                # GraphQLサービスをデプロイ
make deploy-grpc                   # gRPCサービスをデプロイ

# イメージ準備と再デプロイ
make prepare-ecr-image SERVICE_TYPE=api   # APIイメージをECRにプッシュ
make redeploy-api                         # APIサービスを強制再デプロイ
```

### 検証コマンド
```bash
# デプロイ検証
make verify-service SERVICE_TYPE=api      # APIサービスの動作を検証
make verify-all-services                  # すべてのサービスを検証
```

### コスト管理コマンド
```bash
# リソースクリーンアップ（コスト削減）
make cleanup-minimal                      # ECSサービスとロードバランサーのみ削除
make cleanup-standard                     # 上記 + RDSインスタンスを削除
make cleanup-complete                     # すべてのAWSリソースを削除

# 一時デプロイと検証
make verify-and-cleanup-api               # APIを検証後に自動クリーンアップ
make temporary-deploy-api                 # 一時デプロイ、検証、自動クリーンアップ
```

### 作業中のコマンド確認方法

作業中に利用可能なコマンドを確認する場合は、以下のヘルプコマンドを使用できます：

```bash
# すべてのコマンド一覧を表示
make help

# 特定のパターンに一致するコマンドを検索
make help | grep api     # APIに関連するコマンドを表示
make help | grep deploy  # デプロイ関連のコマンドを表示
make help | grep verify  # 検証関連のコマンドを表示
```

また、不明なコマンドがある場合は「どのようなコマンドで〇〇の作業を進めればよいですか？」と質問することで、適切なコマンドを案内します。

AWS関連の作業では、必ず作業完了後にリソース状態を確認し、不要なリソースをクリーンアップしてください。