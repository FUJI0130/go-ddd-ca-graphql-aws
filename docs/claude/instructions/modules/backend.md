# バックエンド開発モジュール

## バックエンド実装ガイドライン

1. **アーキテクチャ規約**:
  - クリーンアーキテクチャの依存関係を厳守
    - ドメイン層: 最も内側のレイヤー（他のレイヤーに依存しない）
    - ユースケース層: ドメイン層のみに依存
    - インターフェース層: ユースケース層とドメイン層に依存
    - インフラストラクチャ層: 他の全レイヤーに依存可能
  - ドメインロジックはentity/valueobjectに集中させる
    - ビジネスルールとドメインの振る舞いをここに記述
    - entity: IDを持ち、ライフサイクルがあるオブジェクト
    - valueobject: 不変で同一性がない値オブジェクト
  - インフラ詳細はinfrastructure層に隠蔽
    - データベースアクセスの詳細実装
    - 外部API連携の実装
    - メッセージングシステムの実装
  - 環境変数による設定の外部化を徹底
    - 環境ごとの設定値は環境変数またはコンフィグファイルに保存
    - ハードコードされた設定値は避ける

2. **エラーハンドリング規約**:
  - ドメインエラー型の統一（pkg/errors）
    - エラーはドメイン層で定義された型を使用
    - エラーコードとメッセージを明確に分離
  - レイヤー間のエラー変換を一貫して実施
    - ドメインエラーからAPIエラーへの変換
    - インフラエラーからドメインエラーへの変換
  - エンドユーザー向けエラーメッセージの標準化
    - ユーザーフレンドリーなメッセージ
    - 技術的詳細の適切な隠蔽
  - エラーハンドリング方針についてはエラーハンドリング方針ガイドライン.mdを参照すること

3. **テスト規約**:
  - テスト実行はMakefileのコマンドを使用
    - GraphQLテスト: `make test-graphql`
    - リポジトリ統合テスト: `make test-integration`
    - 通常テスト: `make test`
  - テストデータ用IDジェネレーターを適切に活用
    - テスト用の一意のIDを生成
    - テスト間の独立性を確保
  - テスト環境のセットアップ手順を厳守
    - テストデータベースの初期化
    - テスト用の環境変数設定
  - テスト失敗時は実装とテストコードの両面から原因を分析し、最適な修正方法を検討
    - 実装コードのバグの可能性
    - テストケースの不備や期待値の誤りの可能性

## バックエンド開発追加注意事項

1. **ファイル依存関係の特定と分析**:
  - インターフェース定義とその実装の関係性を明確に把握
    ```
    # ファイル依存関係の例
    pkg/config/provider.go (インターフェース定義)
    ├── pkg/config/env_provider.go (環境変数プロバイダー実装)
    ├── pkg/config/file_provider.go (ファイルプロバイダー実装)
    └── pkg/config/chain_provider.go (複数プロバイダーの連鎖実装)
    ```
  - 実装前にサンプルコードで依存関係と実装パターンを確認
    ```
    # インターフェース定義例
    // pkg/config/provider.go
    type ConfigProvider interface {
       Get(key string) (string, bool)
       // その他のメソッド...
    }

    # 実装クラス例
    // pkg/config/env_provider.go
    type EnvConfigProvider struct {
       // フィールド...
    }
    
    func (p *EnvConfigProvider) Get(key string) (string, bool) {
       // 実装...
    }
    ```
  - モジュール間の関係性と責務の範囲を明確にする
    - 各モジュールの責務境界を明確にする
    - 重複実装を避けるため既存コードを十分調査

2. **変更影響範囲の分析と計画**:
  - 変更がどこまで影響するかを事前に分析
    ```
    # 影響範囲の例
    pkg/config/config.go の LoadConfig 関数を修正する場合:
    影響を受ける可能性のあるファイル:
    - cmd/api/main.go (LoadConfig の呼び出し)
    - cmd/graphql/main.go (LoadConfig の呼び出し)
    - cmd/grpc/main.go (LoadConfig の呼び出し)
    - internal/infrastructure/persistence/postgres/db.go (設定を使用)
    ```
  - 影響を受けるすべての箇所で整合性を保つ実装計画
    - 破壊的変更の特定と影響範囲の評価
    - 互換性維持のための対策検討
  - テストカバレッジの確保
    - 影響を受ける箇所のテストケース追加
    - エッジケースのテスト追加

3. **GraphQLとAPI実装の注意点**:
  - GraphQLスキーマとリゾルバーの整合性確保
    - スキーマの変更とリゾルバーの実装を同期する
    - 型定義と実際の返却値の型一致を確認
  - データローダーの適切な活用
    - N+1問題の回避
    - バッチ処理によるパフォーマンス最適化
  - RESTとgRPC APIの一貫性維持
    - エンドポイント設計の一貫性
    - エラーレスポンスの統一
    - 認証・認可の統一的な実装